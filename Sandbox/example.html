<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JSON to Diagram Live Editor ğŸ˜</title>
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <!-- CodeMirror í…Œë§ˆ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #header {
            background-color: #282a36;
            color: #f8f8f2;
            padding: 10px;
            text-align: center;
        }

        #main {
            display: flex;
            flex: 1;
        }

        #editor {
            width: 50%;
            height: 100%;
        }

        .CodeMirror {
            height: 100%;
        }

        #diagram {
            width: 50%;
            height: 100%;
            background-color: #ffffff;
            overflow: auto;
            padding: 10px;
        }

        #controls {
            padding: 10px;
            background-color: #f0f0f0;
            text-align: center;
        }

        #controls button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            #main {
                flex-direction: column;
            }
            #editor, #diagram {
                width: 100%;
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>JSON to Diagram Live Editor ğŸ˜</h1>
    </div>

    <div id="main">
        <!-- ì½”ë“œ í¸ì§‘ê¸° ì˜ì—­ -->
        <div id="editor"></div>

        <!-- ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ ì˜ì—­ -->
        <div id="diagram"></div>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì˜ì—­ -->
    <div id="controls">
        <button id="saveBtn">íŒŒì¼ ì €ì¥</button>
        <input type="file" id="loadInput" style="display: none;">
        <button id="loadBtn">íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="exportSvgBtn">SVGë¡œ ë‚´ë³´ë‚´ê¸°</button>
        <button id="exportPngBtn">PNGë¡œ ë‚´ë³´ë‚´ê¸°</button>
    </div>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <!-- CodeMirror ëª¨ë“œ (Markdown ì‚¬ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/markdown/markdown.min.js"></script>
    <!-- FileSaver.js (íŒŒì¼ ì €ì¥ì„ ìœ„í•´ í•„ìš”) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- dom-to-image (PNG ì €ì¥ì„ ìœ„í•´ í•„ìš”) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <script>
        // Mermaid.js ì´ˆê¸°í™”
        mermaid.initialize({ startOnLoad: false });

        // CodeMirror ì´ˆê¸°í™”
        var editor = CodeMirror(document.getElementById("editor"), {
            mode: "markdown",
            theme: "dracula",
            lineNumbers: true,
            value: `flowchart TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[fa:fa-car Car]`,
        });

        // ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§ í•¨ìˆ˜
        async function renderMermaid() {
            var code = editor.getValue();
            var diagramContainer = document.getElementById("diagram");

            // ê¸°ì¡´ ë‹¤ì´ì–´ê·¸ë¨ ì´ˆê¸°í™”
            diagramContainer.innerHTML = '';

            try {
                // ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§
                const { svg, bindFunctions } = await mermaid.render('theGraph', code);
                diagramContainer.innerHTML = svg;
                if (bindFunctions) {
                    bindFunctions(diagramContainer);
                }
            } catch (e) {
                diagramContainer.innerHTML = '<p style="color: red;">ë‹¤ì´ì–´ê·¸ë¨ì„ ë Œë”ë§í•˜ëŠ” ë™ì•ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                console.error('Mermaid.js ì˜¤ë¥˜:', e);
            }
        }

        // ì—ë””í„° ë‚´ìš© ë³€ê²½ ì‹œ ë‹¤ì´ì–´ê·¸ë¨ ì—…ë°ì´íŠ¸
        editor.on('change', function() {
            renderMermaid();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë‹¤ì´ì–´ê·¸ë¨ ë Œë”ë§
        renderMermaid();

        // íŒŒì¼ ì €ì¥ ê¸°ëŠ¥
        document.getElementById('saveBtn').addEventListener('click', function() {
            var blob = new Blob([editor.getValue()], { type: 'text/plain;charset=utf-8' });
            saveAs(blob, 'diagram.mmd');
        });

        // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
        document.getElementById('loadBtn').addEventListener('click', function() {
            document.getElementById('loadInput').click();
        });

        document.getElementById('loadInput').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                editor.setValue(e.target.result);
            };
            reader.readAsText(file);
        });

        // SVGë¡œ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥
        document.getElementById('exportSvgBtn').addEventListener('click', function() {
            var svgContent = document.querySelector('#diagram svg');
            if (svgContent) {
                var blob = new Blob([svgContent.outerHTML], { type: 'image/svg+xml;charset=utf-8' });
                saveAs(blob, 'diagram.svg');
            } else {
                alert('ë‹¤ì´ì–´ê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        });

        // PNGë¡œ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥
        document.getElementById('exportPngBtn').addEventListener('click', function() {
            var diagramElement = document.getElementById('diagram');
            domtoimage.toBlob(diagramElement)
                .then(function(blob) {
                    saveAs(blob, 'diagram.png');
                })
                .catch(function(error) {
                    console.error('PNG ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                });
        });
    </script>
</body>
</html>
